name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  actions: read

env:
  DOCKER_BUILDKIT: 1
  JAVA_VERSION: '21'
  NODE_VERSION: '18'

jobs:
  # Determine version from tag or input
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Remove 'v' prefix if user included it in manual input
            VERSION="${{ github.event.inputs.version }}"
            VERSION="${VERSION#v}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            # Extract version from tag (remove refs/tags/v prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
            # Also handle tags without 'v' prefix
            VERSION="${VERSION#refs/tags/}"
            # Check if it's a prerelease (contains -alpha, -beta, -rc, etc.)
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "üì¶ Preparing release v$VERSION (prerelease: $IS_PRERELEASE)"

  # Build and test backend
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v5
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Update version in pom.xml
        working-directory: ./cinema-manager/backend
        run: |
          ./mvnw versions:set -DnewVersion=${{ needs.prepare.outputs.version }} -DgenerateBackupPoms=false

      - name: Build JAR
        working-directory: ./cinema-manager/backend
        run: ./mvnw clean package -DskipTests -B

      - name: Run tests
        working-directory: ./cinema-manager/backend
        run: ./mvnw test -B
        continue-on-error: true

      - name: Upload backend artifact
        uses: actions/upload-artifact@v6
        with:
          name: backend-jar
          path: cinema-manager/backend/target/*.jar
          retention-days: 5

  # Build frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./cinema-manager/frontend
        run: |
          # Use npm install instead of npm ci to handle package-lock.json sync issues
          npm install --legacy-peer-deps

      - name: Update version in package.json
        working-directory: ./cinema-manager/frontend
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend
        working-directory: ./cinema-manager/frontend
        run: npm run build
        env:
          CI: false
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.example.com/api' }}

      - name: Create frontend archive
        working-directory: ./cinema-manager/frontend
        run: tar -czvf frontend-build.tar.gz build/

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: cinema-manager/frontend/frontend-build.tar.gz
          retention-days: 5

  # Build and push Docker images
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./cinema-manager/backend
          file: ./cinema-manager/backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/cinema-backend:${{ needs.prepare.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/cinema-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./cinema-manager/frontend
          file: ./cinema-manager/frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/cinema-frontend:${{ needs.prepare.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/cinema-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend, build-docker]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./artifacts/backend

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./artifacts/frontend

      - name: Rename artifacts
        run: |
          mv ./artifacts/backend/*.jar ./artifacts/cinema-backend-${{ needs.prepare.outputs.version }}.jar
          mv ./artifacts/frontend/frontend-build.tar.gz ./artifacts/cinema-frontend-${{ needs.prepare.outputs.version }}.tar.gz

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            CHANGELOG="## üéâ Initial Release\n\nThis is the first release of Cinema Management System."
          else
            echo "Generating changelog from $PREV_TAG to HEAD"
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges | head -50)
          fi
          
          # Save to file for multi-line support
          echo -e "$CHANGELOG" > changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Cinema Management System v${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          body_path: changelog.md
          files: |
            ./artifacts/cinema-backend-${{ needs.prepare.outputs.version }}.jar
            ./artifacts/cinema-frontend-${{ needs.prepare.outputs.version }}.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.prepare.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Backend JAR: \`cinema-backend-${{ needs.prepare.outputs.version }}.jar\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Build: \`cinema-frontend-${{ needs.prepare.outputs.version }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKER_USERNAME }}/cinema-backend:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKER_USERNAME }}/cinema-frontend:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # Notify on completion (optional - can be extended for Slack, Discord, etc.)
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: always()
    steps:
      - name: Release Status
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "‚úÖ Release v${{ needs.prepare.outputs.version }} created successfully!"
          else
            echo "‚ùå Release v${{ needs.prepare.outputs.version }} failed!"
            exit 1
          fi
